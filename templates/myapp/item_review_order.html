{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <link rel="stylesheet" href="{% static 'css/colors.css' %}">
    <script src="{% static 'js/theme.js' %}" defer></script>
    <meta charset="UTF-8">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Order Review</title>
    <style>
          body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: url("{% static 'myapp/bg1.png' %}") no-repeat center center fixed;
            background-size: cover;
            margin: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            color: #333;
        }
        .container {
            animation: bounceDown 0.8s ease-out;
            max-width: 900px;
            width: 100%;
            padding: 30px;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 10px;
            box-shadow: 0 8px 15px rgba(0, 0, 0, 0.3);
            text-align: center;
        }
        img {
            max-width: 200px;
            height: auto;
            border-radius: 5px;
        }
        h1 {
            font-size: 32px;
            margin-bottom: 15px;
            font-weight: 600;
            color: var(--primary-color);
        }
        h2 {
            font-size: 24px;
            color: var(--primary-color);
            margin-bottom: 10px;
            font-weight: 500;
        }
        p {
            font-size: 18px;
            margin: 8px 0;
        }
        .review-button, .delete-button, .submit-button {
            display: inline-block;
            margin-top: 15px;
            padding: 12px 25px;
            font-size: 18px;
            color: white;
            background-color: #4b0e0e;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            text-decoration: none;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            box-shadow: 0 5px 10px rgba(0, 0, 0, 0.2);
        }
        .delete-button {
            background-color: var(--primary-color);
            margin-left: 15px;
        }
        .delete-button1 {
            background-color: rgba(149, 143, 143, 0.14);
            margin-left: 15px;
            display: inline-block;
            margin-top: 15px;
            padding: 12px 25px;
            font-size: 18px;
            color: white;
            background-color: #827d7d;
            border: none;
            border-radius: 5px;
            text-decoration: none;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            box-shadow: 0 5px 10px rgba(0, 0, 0, 0.2);
        }
        .review-button:hover, .delete-button:hover, .submit-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 15px rgba(0, 0, 0, 0.3);
            background-color: var(--secondary-color);
        }
        .review-button:active, .delete-button:active, .submit-button:active {
            transform: translateY(2px);
        }
        .status {
            margin-top: 20px;
            font-size: 18px;
            color: #555;
        }
        .or-text {
            margin: 20px 0;
            font-size: 20px;
            font-weight: 500;
            color: var(--primary-color);
        }
        .input-field {
            width: 90%;
            padding: 12px;
            font-size: 16px;
            border: 2px solid #ccc;
            border-radius: 5px;
            margin-bottom: 10px;
            outline: none;
            transition: border-color 0.3s ease;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        .input-field:focus {
            border-color: var(--primary-color);
        }
        /* Overlay styles */
.overlay {
    position: fixed; /* Make the overlay cover the entire viewport */
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.5); /* Semi-transparent background */
    display: none; /* Hidden by default */
    z-index: 1000; /* Above other elements */
}

/* Popup styles */
.popup {
    position: fixed; /* Position it relative to the viewport */
    top: 50%; /* Center vertically */
    left: 50%; /* Center horizontally */
    transform: translate(-50%, -50%); /* Adjust for element size */
    background-color: white; /* White background for the popup */
    border-radius: 8px; /* Rounded corners */
    padding: 20px; /* Inner spacing */
    box-shadow: 0 0 15px rgba(0, 0, 0, 0.3); /* Soft shadow */
    z-index: 1001; /* Above overlay */
    display: none; /* Hidden by default */
}

/* Additional styles for buttons and inputs */
.input-field {
    width: 100%; /* Full width */
    margin-bottom: 10px; /* Space between inputs */
    padding: 10px; /* Inner spacing */
    border: 1px solid #ccc; /* Light border */
    border-radius: 5px; /* Rounded corners */
}

button {
    margin-right: 5px; /* Space between buttons */
}
@keyframes bounceDown {
    0% {
        opacity: 0;
        transform: translateY(-100px) scale(0.9);
    }
    60% {
        opacity: 1;
        transform: translateY(20px) scale(1.05);
    }
    80% {
        transform: translateY(-10px) scale(0.98);
    }
    100% {
        transform: translateY(0) scale(1);
    }
}
h1, h2, p, .status{
    color: var(--primary-color);
    text-align: center;
    font-family: 'Palatino Linotype', 'Book Antiqua', Palatino, serif;
    font-weight: bold;
    text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.2);
}

  .containerx {
            display: flex;
            justify-content: space-between;
            gap: 15px;
            align-items: center;
            margin-top: 20px;
            background: rgba(240, 240, 240, 0.9);
            padding: 10px;
            border-radius: 15px;
            box-shadow: 0px 5px 15px rgba(0, 0, 0, 0.2);
        }
        table {
            box-shadow: 0px 5px 15px rgba(0, 0, 0, 0.45);
            margin-top: 4vh;
    width: 100%; /* Make the table take the full width */
    border-collapse: collapse; /* Remove spacing between cells */
    table-layout: auto; /* Let the browser auto adjust the column widths */
}

th, td {
    padding: 8px 16px; /* Adjust padding for compact rows */
    text-align: left;
    border: 1px solid #333; /* Dark borders */
    white-space: nowrap; /* Prevent text from wrapping, forcing cells to stay wide */
}
        th {
            background-color: var(--primary-color);
            color: white;
            font-weight: bold;
        }
        td {
            font-family: 'Palatino Linotype', 'Book Antiqua', Palatino, serif;
            font-weight: bold;
            background-color: #f9f9f9;
        }
         tr {
    height: 30px; /* Adjust height for table rows */
}


        canvas {

            width: 45%;
            height: 300px;
            transform: scale(0.8);
            margin-right: 7vw;
            box-shadow: 0px 5px 15px rgba(0, 0, 0, 0.45);
            border-radius: 10px;
            background-color: #fff;
        }

    </style>
</head>
<body onload="loadTheme1()">
{% if xd %}
<div>{% include 'myapp/sidebar.html' %}</div>
    {% else %}
    <div>{% include 'myapp/sidebar.html' with webc='3' %}</div>
{% endif %}
    <div class="container">

        <h1>Order Review</h1>
        <h2>Item Name: {{ item_name }}</h2>
        <p>Unique Number: {{ item_unique_number }}</p>
        <img src="{{ item_image }}" alt="{{ item_name }}">
        <p>Order ID: {{ order_id }}</p>
        <p>Quantity: {{ order_quantity }}</p>
        <p>Features: {{ item_features }}</p>
    {% if order_email  %}
        <p>Order Email: {{ order_email }}</p>
    {% endif %}
{% if not xd %}
        {% if not order_reviewed %}
            <!-- Show the review button if the order has not been reviewed -->
            <button class="review-button" onclick="askForContactDetails(1)">üé§ Give Review</button>

            <div class="or-text">(OR)</div>

            <input type="text" id="reviewTextInput" class="input-field" placeholder="Type your review here...">
            <button class="submit-button" onclick="submitReview()">Submit Review</button>

            <div class="status" id="status">Press the button or type in your review above.</div>
           <a href="{% url 'reviewspage' %}" class="btn btn-primary" style="display: block; margin-top: 10px;">Review Another Order</a>
        {% else %}
            <!-- Show the review text and reply if the order has been reviewed -->
            <p><strong>Already reviewed</strong></p>
            <div class="status" id="status"></div>
            {% if not ticket_status %}
            <button class="delete-button" onclick="deleteReview()">üóëÔ∏è Delete Review</button>
                {% else %}
                <button class="delete-button1">Ticket already assigned</button>
                <p>Ticket ID: {{ ticket_id }}</p>

           {% endif %}
                <a href="{% url 'reviewspage' %}" class="btn btn-primary" style="display: block; margin-top: 10px;">Review Another Order</a>
        {% endif %}
    {% else %}
    <div class="status" id="status"></div>
     <div class="containerx">
        <table>
        <thead>
            <tr>
                <th>Order Date</th>
                <th>Quantity</th>
            </tr>
        </thead>
        <tbody>
            {% for ord in orders_customer %}
                <tr>
                    <td>{{ ord.created_at|date:'Y-m-d' }}</td>
                    <td>{{ ord.quantity }}</td>
                </tr>
            {% endfor %}
        </tbody>
    </table>

        <!-- Canvas for the chart -->
        <canvas id="orderChart"></canvas>
    </div>
    <script>
        // Data preparation for the chart
       const orderDates = {{ dates|safe }};
    const orderQuantities = {{ quantities|safe }};

    // Create the chart
    const ctx = document.getElementById('orderChart').getContext('2d');
    const orderChart = new Chart(ctx, {
        type: 'line', // Line chart
        data: {
            labels: orderDates,
            datasets: [{
                label: 'Quantity Ordered',
                data: orderQuantities,
                borderColor: 'rgba(75, 192, 192, 1)',
                backgroundColor: 'rgba(75, 192, 192, 0.2)',
                borderWidth: 2,
                fill: true, // Fill area under line
            }]
        },
        options: {
            responsive: true,
            scales: {
                x: {
                    title: {
                        display: true,
                        text: 'Order Date',
                    },
                },
                y: {
                    title: {
                        display: true,
                        text: 'Quantity',
                    },
                    beginAtZero: true,
                },
            },
        }
    });
    </script>
    {% endif %}
    </div>
    <!-- Overlay for popups -->
  <!-- Overlay for popups -->
<div class="overlay" id="overlay" style="display: none;"></div>

<!-- Popup for contact details -->
<div class="popup" id="contactPopup" style="display: none;">
    <h3>Contact Details</h3>
    <p>An OTP will be sent to your registered email id to authorize you to review this product. You will be further contacted through this email id for any further queries.</p>
    <input type="email" id="emailField" class="input-field" placeholder="Email">
    <input type="tel" id="phoneField" class="input-field" placeholder="Phone">
    <button onclick="requestOTP()">Submit</button>
    <button onclick="closePopup()">Cancel</button>
</div>

<!-- Popup for OTP -->
<div class="popup" id="otpPopup" style="display: none;">
    <h3>Enter OTP</h3>
    <input type="text" id="otpField" class="input-field" placeholder="Enter OTP">
    <button onclick="verifyOTP()">Verify OTP</button>
    <button onclick="closeOtpPopup()">Cancel</button>
</div>


    <script>
    let orderEmail = null
    {% if order_email %}
         orderEmail = "{{ order_email }}";
    {% endif %}
        document.addEventListener("DOMContentLoaded", function() {
         {% if order_reviewed %}
    const statusEl = document.getElementById('status');
    statusEl.innerHTML = `
        <table style="width: auto; margin: 0 auto; border-collapse: collapse; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2); border-radius: 8px; overflow: hidden;">
    <thead>
        <tr>
            <th style="border: 1px solid #ddd; padding: 12px; text-align: center; background-color: var(--primary-color); font-weight: bold; font-size: 1.1em;">Review</th>
            <th style="border: 1px solid #ddd; padding: 12px; text-align: center; background-color: var(--primary-color); font-weight: bold; font-size: 1.1em;">Reply</th>
        </tr>
    </thead>
    <tbody>
        <tr>
    <td style="border: 1px solid #ddd; padding: 10px; text-align: center; max-width: 400px; word-wrap: break-word; white-space: normal;">
        <strong>{{ review_text }}</strong>
    </td>
    <td style="border: 1px solid #ddd; padding: 10px; text-align: center; max-width: 400px; word-wrap: break-word; white-space: normal;">
        <strong>{{ reply_text }}</strong>
    </td>
</tr>
    </tbody>
</table>
        <br>
    `;
{% endif %}
        });
        function askForContactDetails(x) {
            document.getElementById('overlay').style.display = 'block';
            document.getElementById('contactPopup').style.display = 'block';
            window.reviewType = x;
        }

        function closePopup() {
            document.getElementById('overlay').style.display = 'none';
            document.getElementById('contactPopup').style.display = 'none';
        }

        function requestOTP() {
            // Get values of the email and phone fields
        const email = document.getElementById('emailField').value.trim();
        const phone = document.getElementById('phoneField').value.trim();

        if (orderEmail && email !== orderEmail) {
            alert("Please enter the email of the order");
            return; // Stop the function execution
        }
        // Check if at least one field is filled
        if (!email && !phone) {
            alert("Please provide at least an email or a phone number.");
            return; // Stop the function execution if both fields are empty
        }
        if (email && !phone) {
            window.cn = email
        }
        else if(phone && !email){
            window.cn = email
        }
        else if(email && phone){
            window.cn = email
        }



            // Here you should implement the logic to send OTP to the provided email or phone number

            // Close contact popup
            closePopup();

            // Open OTP popup
            document.getElementById('otpPopup').style.display = 'block';
        }

        function closeOtpPopup() {
            document.getElementById('otpPopup').style.display = 'none';
        }

        function verifyOTP() {
            const otp = document.getElementById('otpField').value;

            // Here you should implement the logic to verify the OTP

            // Close OTP popup and start listening for review
            closeOtpPopup();
            if (window.reviewType === 1) {
        startListening();  // If type is 1, start listening for review
    } else if (window.reviewType === 2) {
        submitReviewRequest(window.re_text)    // If type is 2, submit the review directly
    }
        }

        function startListening() {
            const statusEl = document.getElementById('status');
            const recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
            recognition.lang = 'en-US';
            recognition.interimResults = false;
            recognition.continuous = false;

            statusEl.textContent = "Listening... Please speak your review.";

            recognition.onresult = function(event) {
                const transcript = event.results[0][0].transcript;
                console.log('User review:', transcript);
                statusEl.textContent = "Processing review...";

                submitReviewRequest(transcript);
            };

            recognition.onerror = function(event) {
                statusEl.textContent = "Error occurred: " + event.error;
            };

            recognition.onspeechend = function() {
                statusEl.textContent = "Processing Review, please hold on..";
                recognition.stop();
            };

            recognition.start();
        }

        function submitReview() {
            const reviewText = document.getElementById('reviewTextInput').value.trim();
            const statusEl = document.getElementById('status');
            statusEl.textContent = "Processing Review, please hold on..";
            if (reviewText === "") {
                alert("Please enter your review before submitting.");
                return;
            }
            window.re_text = reviewText
            askForContactDetails(2);

        }

        function submitReviewRequest(review) {
            fetch(`/give-review/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify({
                    review: review,
                    order_id: "{{ order_id }}",
                    eml: window.cn
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    window.location.reload();
                    document.getElementById('status').innerHTML = `Thank you for your review! <br><br> <strong>Reply:</strong> <br> ${data.draft_reply}`;
                } else {
                    document.getElementById('status').textContent = `Error: ${data.message}`;
                }
            })
            .catch(error => {
                console.error('Error:', error);
                document.getElementById('status').textContent = "An error occurred while submitting your review.";
            });
        }

        function deleteReview() {
            if (confirm('Are you sure you want to delete this review?')) {
                fetch(`/delete-review/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token }}'
                    },
                    body: JSON.stringify({ order_id: '{{ order_id }}' })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('Review deleted successfully.');
                        window.location.reload();
                    } else {
                        alert(data.message || 'Error deleting review. Please try again.');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Error deleting review.');
                });
            }
        }
    </script>
</body>
</html>
